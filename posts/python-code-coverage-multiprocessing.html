<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# " lang="en">
    <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>python code coverage &amp; multiprocessing | schettino72</title>

    
            <link href="../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">

    
        <link rel="alternate" type="application/rss+xml" title="RSS (en)" href="http://feeds.feedburner.com/schettino72">

      <link rel="canonical" href="http://blog.schettino72.net/posts/python-code-coverage-multiprocessing.html">




    
        <!--[if lt IE 9]><script src="../assets/js/html5.js"></script><![endif]-->

    


    

    <meta name="author" content="schettino72">
        <link rel="prev" href="doit-task-creation.html" title="doit task creation" type="text/html">
        <link rel="next" href="strace-build-tools.html" title="strace &amp; build-tools" type="text/html">
    
    <meta name="og:title" content="python code coverage &amp; multiprocessing">
    <meta name="og:url" content="http://blog.schettino72.net/posts/python-code-coverage-multiprocessing.html">
    <meta name="og:description" content="I wanted to get code coverage
for my python code that uses the multiprocessing module.
The default way of coverage measuring in subprocess
is to set the python interpreter to turn on code coverage rig">
    <meta name="og:site_name" content="schettino72">
    <meta name="og:type" content="article">

    

    



</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="http://blog.schettino72.net/">

                <span id="blog-title">schettino72</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                
                <li>
<a href="../archive.html">Archive</a>
                </li>
<li>
<a href="../categories/index.html">Tags</a>
                </li>
<li>
<a href="../rss.xml">RSS feed</a>

                
            </li>
</ul>

            <ul class="nav navbar-nav navbar-right">
                
                
                
            </ul>
        </div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav>

<!-- End of Menubar -->

<div class="container" id="content">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article">
    
    <header>
        
    <h1 class="p-name entry-title" itemprop="headline name"><a href="#" class="u-url">python code coverage &amp; multiprocessing</a></h1>

        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn">schettino72</span></p>
            <p class="dateline"><a href="#" rel="bookmark"><time class="published dt-published" datetime="2012-12-30T06:45:00+08:00" itemprop="datePublished" title="Publication date">2012-12-30 06:45</time></a></p>
                <p class="commentline">
        
    <a href="python-code-coverage-multiprocessing.html#disqus_thread" data-disqus-identifier="_cache/_posts/coverage-multiprocessing.html">Comments</a>


            

        </p>
</div>
        

    </header>

    <div class="e-content entry-content" itemprop="articleBody text">
    <div>
<p>I wanted to get code <a href="http://nedbatchelder.com/code/coverage">coverage</a>
for my python code that uses the <a href="http://docs.python.org/2.7/library/multiprocessing.html">multiprocessing</a> module.</p>
<p>The default way of coverage <a href="http://nedbatchelder.com/code/coverage/subprocess.html">measuring in subprocess</a>
is to set the python interpreter to turn on code coverage right on start-up.
But this technique won't work if the process being measured <em>forks</em>
(as it does in multiprocessing).
See <a href="https://bitbucket.org/ned/coveragepy/issue/117/enable-coverage-measurement-of-code-run-by">issue</a>.</p>
<p>I solved this by monkey-patching the multiprocess to programmatically
start the coverage.
Only the method <code>Process._bootstrap</code> needs to be monkey-patched.
It is just wrapped with some code to start the coverage and
save it when it is done.</p>
<pre class="code literal-block"><span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Process</span>

<span class="k">def</span> <span class="nf">coverage_multiprocessing_process</span><span class="p">():</span> <span class="c"># pragma: no cover</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">coverage</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="c"># give up monkey-patching if coverage not installed</span>
        <span class="k">return</span>

    <span class="kn">from</span> <span class="nn">coverage.collector</span> <span class="kn">import</span> <span class="n">Collector</span>
    <span class="kn">from</span> <span class="nn">coverage.control</span> <span class="kn">import</span> <span class="n">coverage</span>
    <span class="c"># detect if coverage was running in forked process</span>
    <span class="k">if</span> <span class="n">Collector</span><span class="o">.</span><span class="n">_collectors</span><span class="p">:</span>
        <span class="k">class</span> <span class="nc">Process_WithCoverage</span><span class="p">(</span><span class="n">Process</span><span class="p">):</span>
            <span class="k">def</span> <span class="nf">_bootstrap</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="n">cov</span> <span class="o">=</span> <span class="n">coverage</span><span class="p">(</span><span class="n">data_suffix</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="n">cov</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">Process</span><span class="o">.</span><span class="n">_bootstrap</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                <span class="k">finally</span><span class="p">:</span>
                    <span class="n">cov</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
                    <span class="n">cov</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">Process_WithCoverage</span>

<span class="n">ProcessCoverage</span> <span class="o">=</span> <span class="n">coverage_multiprocessing_process</span><span class="p">()</span>
<span class="k">if</span> <span class="n">ProcessCoverage</span><span class="p">:</span>
    <span class="n">Process</span> <span class="o">=</span> <span class="n">ProcessCoverage</span>
</pre>


<p>Note that the monkey-patch is only applied when the original process
was being covered.
This is done by checking if there are any <code>Collector</code>.</p>
<p>When running the <code>coverage</code> you need use the <code>parallel-mode</code> and
than combine the results before creating report:</p>
<pre class="code literal-block"><span class="err">$</span> <span class="n">coverage</span> <span class="n">run</span> <span class="o">--</span><span class="n">parallel</span><span class="o">-</span><span class="n">mode</span> <span class="n">my_program</span><span class="p">.</span><span class="n">py</span>
<span class="err">$</span> <span class="n">coverage</span> <span class="n">combine</span>
<span class="err">$</span> <span class="n">coverage</span> <span class="n">report</span>
</pre>
</div>
    </div>
    <aside class="postpromonav">
    <nav>
    
        <ul itemprop="keywords" class="tags">
           <li><a class="tag p-category" href="../categories/python.html" rel="tag">python</a></li>
        </ul>

    
        <ul class="pager">
            <li class="previous">
                <a href="doit-task-creation.html" rel="prev" title="doit task creation">Previous post</a>
            </li>
            <li class="next">
                <a href="strace-build-tools.html" rel="next" title="strace &amp; build-tools">Next post</a>
            </li>
        </ul>

    </nav>
    </aside>
        <section class="comments">
        <h2>Comments</h2>
        
        
        <div id="disqus_thread"></div>
        <script>
        var disqus_shortname ="schettino72blog",
            disqus_url="http://blog.schettino72.net/posts/python-code-coverage-multiprocessing.html",
        disqus_title="python code coverage & multiprocessing",
        disqus_identifier="_cache/_posts/coverage-multiprocessing.html",
        disqus_config = function () {
            this.language = "en";
        };
        (function() {
            var dsq = document.createElement('script'); dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
</noscript>
    <a href="//disqus.com" class="dsq-brlink" rel="nofollow">Comments powered by <span class="logo-disqus">Disqus</span></a>


        </section>
    

</article>

        
       <script>var disqus_shortname="schettino72blog";(function(){var a=document.createElement("script");a.async=true;a.src="//"+disqus_shortname+".disqus.com/count.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)}());</script>



        </div>
        <!--End of body content-->

        <footer>
            Contents © schettino72 - Powered by <a href="http://getnikola.com">Nikola</a>         
            
        </footer>
    </div>
</div>


            <script src="../assets/js/all-nocdn.js"></script>
    
<!-- Social buttons -->
<div id="addthisbox" class="addthis_toolbox addthis_peekaboo_style addthis_default_style addthis_label_style addthis_32x32_style">
<a class="addthis_button_more">Share</a>
<ul>
<li>
<a class="addthis_button_facebook"></a>
</li>
<li>
<a class="addthis_button_google_plusone_share"></a>
</li>
<li>
<a class="addthis_button_linkedin"></a>
</li>
<li>
<a class="addthis_button_twitter"></a>
</li>
</ul>
</div>
<script src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-4f7088a56bb93798"></script>
<!-- End of social buttons -->


    <script>jQuery("a.image-reference").colorbox({rel:"gal",maxWidth:"100%",maxHeight:"100%",scalePhotos:true});</script>
    

<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-36931321-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>


</body>
</html>
