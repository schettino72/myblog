<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="title" content="power up your tools | Rounder Wheels"><meta name="description" content=""><meta name="author" content="schettino72"><title>power up your tools | Rounder Wheels</title><!-- Le styles --><link href="../assets/css/bootstrap.css" rel="stylesheet" type="text/css"><link href="../assets/css/rst.css" rel="stylesheet" type="text/css"><link href="../assets/css/code.css" rel="stylesheet" type="text/css"><link href="../assets/css/colorbox.css" rel="stylesheet" type="text/css"><link href="../assets/css/slides.css" rel="stylesheet" type="text/css"><link href="../assets/css/theme.css" rel="stylesheet" type="text/css"><link href="../assets/css/custom.css" rel="stylesheet" type="text/css"><link href="../assets/css/bootstrap-responsive.css" rel="stylesheet" type="text/css"><script src="../assets/js/jquery-1.7.2.min.js" type="text/javascript"></script><script src="../assets/js/jquery.colorbox-min.js" type="text/javascript"></script><script src="../assets/js/slides.min.jquery.js" type="text/javascript"></script><script src="../assets/js/bootstrap.min.js" type="text/javascript"></script><!-- Le HTML5 shim, for IE6-8 support of HTML5 elements --><!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js" type="text/javascript"></script>
    <![endif]--><link rel="alternate" type="application/rss+xml" title="RSS (en)" href="http://feeds.feedburner.com/schettino72"></head><body>
  <div class="container-fluid" id="container">
    <div class="row-fluid">
      <!-- top header -->
      <div class="span12" id="titlecolumn">
        <h1 id="blog-title">
          <a href="../" title="Rounder Wheels">Rounder Wheels</a>
          <small>  by <a href="#">schettino72</a></small>
        </h1>
        
        <hr></div>

      <!-- content -->
      <div class="row-fluid" id="contentrow">
        <div class="span10" id="contentcolumn">
          <!--Body content-->
          
    <div class="postbox">
    <h1><a href="#">power up your tools</a>
          <small>2012-12-06</small></h1>
    <small>
        

        
            <a class="tag" href="../categories/python.html"><span class="badge badge-info">python</span></a>
            <a class="tag" href="../categories/doit.html"><span class="badge badge-info">doit</span></a>

    </small>
    <hr><div><h2>Goal</h2>
<p><a href="http://pypi.python.org/pypi/pyflakes&gt;">pyflakes</a> is a static checker for python.
It is great but it lacks a few features:</p>
<ul><li>no parallel multi-processing execution</li>
<li>no cache to avoid checking files that were not modified</li>
<li>no option to have a long running process that watches the file system
   and automatically re-executes the checker when files are modified</li>
</ul><p>These features are not specific to a static checker and are nice to have
to many other tools.
This post shows how to create an application adding those features.
It uses pyflakes as an example but it could be applied to other tools also.</p>
<h2>static checker tasks</h2>
<p><a href="http://pydoit.org">doit</a> is an "automation tool" that can execute <strong>tasks</strong>
and provide the features which we are interested into. So the first step is to
transform pyflakes operations into <strong>doit tasks</strong>.</p>
<p>In <em>doit</em> a <em>task</em> is composed of <strong>actions</strong>, and some other <strong>metadata</strong>.</p>
<h3>actions</h3>
<p>The <em>action</em> describes what the <em>task</em> does
(some code to be executed). It can be a python function...</p>
<p>For pyflakes the function <code>pyflakes.scripts.pyflakes.checkPath</code>
checks a file and returns the number of <em>flakes</em> or
warnings found, so it is successful when zero flakes were found.</p>
<p>The action's return value is used to indicate if the execution
was successful or not. So the action must return <code>True</code> if it has zero <em>flakes</em></p>
<p>pyflakes checker action:</p>
<div class="code"><pre><span class="kn">from</span> <span class="nn">pyflakes.scripts.pyflakes</span> <span class="kn">import</span> <span class="n">checkPath</span>

<span class="k">def</span> <span class="nf">check_path</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="k">return</span> <span class="ow">not</span> <span class="nb">bool</span><span class="p">(</span><span class="n">checkPath</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
</pre></div>


<h3>dependencies</h3>
<p>A <strong>dependency</strong> indicates something that is required for a task execution.</p>
<p>For the pyflakes task, the file being checked is a <em>file dependency</em> for the task.
That is, the task uses the file as input for its execution.</p>
<p>Explicit information of task dependencies are important for two factors:</p>
<p>1) cache results, if dependencies are not modified since last time the task
   was executed. It can use the results saved in a cache instead of re-executing
   the task.</p>
<p>2) execution order, when dealing with the execution of several tasks,
   the dependencies contains information on the order that tasks should be executed
   and whether they can be executed simultaneously (in parallel).</p>
<h2>task creation</h2>
<p>In <em>doit</em> usually task creation is done in a python module.
This module functions that return/yield new tasks as a dict with metadata.
It can also contain some extra configuration.</p>
<p>Something like:</p>
<div class="code"><pre><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">glob</span>

<span class="kn">from</span> <span class="nn">pyflakes.scripts.pyflakes</span> <span class="kn">import</span> <span class="n">checkPath</span>

<span class="n">DOIT_CONFIG</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c"># output from actions should be sent to the terminal/console</span>
    <span class="s">'verbosity'</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="c"># does not stop execution on first task failure</span>
    <span class="s">'continue'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
    <span class="c"># doit itself should not produce any output (use only actions output)</span>
    <span class="s">'reporter'</span><span class="p">:</span> <span class="s">'zero'</span><span class="p">,</span>
    <span class="c"># use multi-processing / parallel execution</span>
    <span class="s">'num_process'</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="p">}</span>

<span class="k">def</span> <span class="nf">check_path</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="sd">"""execute pyflakes checker"""</span>
    <span class="k">return</span> <span class="ow">not</span> <span class="nb">bool</span><span class="p">(</span><span class="n">checkPath</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">task_pyflakes</span><span class="p">():</span>
    <span class="sd">"""generate task for each file to be checked"""</span>
    <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s">'*.py'</span><span class="p">):</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">yield</span> <span class="p">{</span>
            <span class="s">'name'</span><span class="p">:</span> <span class="n">path</span><span class="p">,</span> <span class="c"># name required to identify tasks</span>
            <span class="s">'file_dep'</span><span class="p">:</span> <span class="p">[</span><span class="n">path</span><span class="p">],</span> <span class="c"># file dependency</span>
            <span class="s">'actions'</span><span class="p">:</span> <span class="p">[(</span><span class="n">check_path</span><span class="p">,</span> <span class="p">(</span><span class="n">filename</span><span class="p">,))</span> <span class="p">],</span>
            <span class="p">}</span>
</pre></div>


<p>If you drop the content above in a file called <em>dodo.py</em> in a folder.
Executing <code>doit</code> from the command line you would execute pyflakes in
all python modules in that folder.</p>
<p>It already has multi-process support.
And it would execute only tasks that were failing or which checked
module file was changed.</p>
<p>To execute in a long running process that watched the file system and re-execute
tasks you could execute it as <code>doit auto</code>.</p>
<h2>creating a new tool</h2>
<p>Creating tasks in <em>dodo.py</em> works fine if you are working on your own project.
But sometimes you just want to create a new application that you can easily
distribute to other users without requiring them to add any special file into their
project.</p>
<p><em>doit</em> latest release (0.18) has exposed some of its internal API so you can
create new applications and still use its task execution model.</p>
<p>The idea is that instead of loading tasks from a <em>dodo.py</em> module,
the application itself create tasks and execute <em>doit</em>.</p>
<h3>custom task loader</h3>
<p>To create a custom task loader you should subclass <code>doit.cmd_base.TaskLoader</code>
and implement the method <code>load_tasks</code></p>
<p><em>pyflakes</em> command line is extremely simple. It doesn't even support a <code>--help</code>
option. It only takes positional parameter that specify python modules or
folders containing python modules.</p>
<p>The first change from the previous example using <em>dodo.py</em> is to get
a list of files in the same way pyflakes does instead of just getting
all modules from a folder...</p>
<p>So on <code>__init__</code> the loader will find the list of files
to be checked.</p>
<div class="code"><pre><span class="kn">from</span> <span class="nn">doit.cmd_base</span> <span class="kn">import</span> <span class="n">TaskLoader</span>

<span class="k">class</span> <span class="nc">FlakeTaskLoader</span><span class="p">(</span><span class="n">TaskLoader</span><span class="p">):</span>
    <span class="sd">"""create pyflakes tasks on the fly based on cmd-line arguments"""</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="sd">"""set list of files to be checked</span>
<span class="sd">        @param args (list - str) file/folder path to apply pyflakes</span>
<span class="sd">        """</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">arg</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">dirpath</span><span class="p">,</span> <span class="n">dirnames</span><span class="p">,</span> <span class="n">filenames</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">arg</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">'.py'</span><span class="p">):</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="n">filename</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">'</span><span class="si">%s</span><span class="s">: No such file or directory</span><span class="se">\n</span><span class="s">'</span> <span class="o">%</span> <span class="n">path</span><span class="p">)</span>
</pre></div>


<p>Than we need to change the function generating tasks to use
the computed files instead of using <em>glob</em>.</p>
<div class="code"><pre>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">check_path</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
        <span class="sd">"""execute pyflakes checker"""</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="nb">bool</span><span class="p">(</span><span class="n">checkPath</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_gen_tasks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""generate doit tasks for each file to be checked"""</span>
        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="k">yield</span> <span class="p">{</span>
                <span class="s">'name'</span><span class="p">:</span> <span class="n">path</span><span class="p">,</span>
                <span class="s">'file_dep'</span><span class="p">:</span> <span class="p">[</span><span class="n">path</span><span class="p">],</span>
                <span class="s">'actions'</span><span class="p">:</span> <span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">check_path</span><span class="p">,</span> <span class="p">(</span><span class="n">filename</span><span class="p">,))],</span>
                <span class="p">}</span>
</pre></div>


<p>Usually <em>doit</em> creates a file named <code>.doit.db</code> to store some information
that will be used to determine which tasks are up-to-date. This file is
created in the same location path as the <em>dodo.py</em> file. Since our new
application works independent from the current path we specify the
<em>store</em> file (<code>dep_file</code>) to be saved in the user's directory.</p>
<div class="code"><pre>    <span class="n">DOIT_CONFIG</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">'verbosity'</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
        <span class="s">'continue'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
        <span class="s">'reporter'</span><span class="p">:</span> <span class="s">'zero'</span><span class="p">,</span>
        <span class="s">'dep_file'</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s">"~"</span><span class="p">),</span> <span class="s">'.doflakes'</span><span class="p">),</span>
        <span class="s">'num_process'</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
        <span class="p">}</span>
</pre></div>


<p>And finally we implement the <code>TaskLoader</code> interface:</p>
<div class="code"><pre>    <span class="k">def</span> <span class="nf">load_tasks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="sd">"""implements loader interface, return (tasks, config)"""</span>
        <span class="k">return</span> <span class="n">generate_tasks</span><span class="p">(</span><span class="s">'pyflakes'</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gen_tasks</span><span class="p">()),</span> <span class="bp">self</span><span class="o">.</span><span class="n">DOIT_CONFIG</span>
</pre></div>


<p>The command line implementation we just need to pass the positional parameters
to the custom task loader.
We also need to add a <code>-w</code> command line option to use the <em>watch</em> mode where
the process keeps waiting for modifications in the file system.</p>
<div class="code"><pre><span class="kn">from</span> <span class="nn">doit.doit_cmd</span> <span class="kn">import</span> <span class="n">DoitMain</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="s">'run'</span> <span class="c"># default doit command</span>
    <span class="n">args</span> <span class="o">=</span> <span class="p">[]</span> <span class="c"># list of positional args from cmd line</span>
    <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
        <span class="k">if</span> <span class="n">arg</span> <span class="o">==</span> <span class="s">'-w'</span><span class="p">:</span> <span class="c"># watch for changes</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="s">'auto'</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
    <span class="n">doit_main</span> <span class="o">=</span> <span class="n">DoitMain</span><span class="p">(</span><span class="n">FlakeTaskLoader</span><span class="p">(</span><span class="n">args</span><span class="p">))</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">doit_main</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="n">cmd</span><span class="p">]))</span>
</pre></div>


<p>The full code can be found here <a href="https://bitbucket.org/schettino72/doit-recipes/src/tip/doflakes/doflakes.py">doflakes.py</a> .</p>
<h2>power up your tools!</h2>
<p>Using <em>doit</em> you can easily add some nice features to external tools
or leverage its power in the tools you are the author!</p>
<p><em>doit</em> has a very flexible dependency system that can be used to perform
tasks much more complex than simple static checkers.</p>
<p>For more information check <a href="http://pydoit.org">doit website</a>.</p></div>
    
    <ul class="pager"><li class="next">
            <a href="doit-task-decorator.html">Next post →</a>
        </li>
    </ul><div id="disqus_thread"></div>    
        <script type="text/javascript">
        var disqus_shortname ="schettino72blog";
        var disqus_url="http://blog.schettino72.net/posts/power-up-your-tools.html";
        var disqus_title="power up your tools";
        var disqus_identifier="_cache/_posts/power-up-your-tools.html";
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

    </div>

          <!--End of body content-->
          <hr><small>Contents © 2012 schettino72 - Powered by <a href="http://nikola.ralsina.com.ar">Nikola</a></small>
      </div>

      <!--Sidebar content-->
      <div class="span2" id="sidebar">
        <ul class="unstyled"><li>
  <a href="http://feeds.feedburner.com/schettino72?format=xml" rel="alternate" type="application/rss+xml"><img src="http://www.feedburner.com/fb/images/pub/feed-icon16x16.png" alt="" style="vertical-align:middle;border:0"></a> <a href="http://feeds.feedburner.com/schettino72?format=xml" rel="alternate" type="application/rss+xml">feed</a>
</li>
          <li>
            </li><li><a href="../archive/index.html">Archives</a>
            </li><li><a href="../categories/index.html">Tags</a>
</li>
          <li>
        </ul></div>
      <!--End of sidebar content-->

      
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-36931321-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script></div></div></div></body></html>