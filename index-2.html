<!DOCTYPE html><html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="on programming">
    <meta name="author" content="schettino72">
    <title>schettino72 (old posts page 2) | schettino72</title>
    
            <link href="assets/css/bootstrap.min.css" rel="stylesheet" type="text/css">
        <link href="assets/css/rst.css" rel="stylesheet" type="text/css">
        <link href="assets/css/code.css" rel="stylesheet" type="text/css">
        <link href="assets/css/colorbox.css" rel="stylesheet" type="text/css">
        <link href="assets/css/theme.css" rel="stylesheet" type="text/css">
            <link href="assets/css/custom.css" rel="stylesheet" type="text/css">
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js" type="text/javascript"></script>
    <![endif]-->
        <link rel="alternate" type="application/rss+xml" title="RSS (en)" href="http://feeds.feedburner.com/schettino72">

    
    
    
</head>
<body>
<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href=".">schettino72</a>
    </div>
    <div class="collapse navbar-collapse navbar-ex1-collapse">
        <ul class="nav navbar-nav">
            
                <li><a href="archive/index.html">Archives</a>
                </li><li><a href="categories/index.html">Tags</a>

        </li></ul>

        <ul class="nav navbar-nav navbar-right">
            
            
                
        </ul>
    </div><!-- /.navbar-collapse -->
  </div>
</nav>

<!-- End of Menubar -->

<div class="container">
    <div class="body-content">
        <!--Body content-->
            
        <article class="postbox h-entry">
        <h1 class="p-name"><a href="posts/mongodb-setup-deployd-heroku.html" class="u-url">mongodb setup for deployd on heroku</a>
        <small>  
             Posted: <time class="published dt-published" datetime="2013-01-27T00:00:00+00:00">2013-01-27</time>
        </small></h1>
        <hr>
        <div class="e-content">
        <div><p>I am using <a href="http://deployd.com/">deployd</a> to prototype an applicaton.
It's been great, really helped me focus on what matters for the prototype.</p>
<p>Today I reached the first milestone and decided to deploy it in
<a href="http://www.heroku.com/">heroku</a>.</p>
<p>I had a small problem because <em>deployd</em> uses an object to config <em>mongodb</em>,
but <em>heroku</em> provides only a URL to mongodb server...
So here is the script I am using to run <em>deployd</em> on <em>heroku</em>:</p>
<div class="code"><pre><span class="kd">var</span> <span class="nx">deployd</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'deployd'</span><span class="p">);</span>

<span class="c1">// on heroku must use port from env</span>
<span class="kd">var</span> <span class="nx">port</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PORT</span> <span class="o">||</span> <span class="mi">3000</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'url'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">db_url</span> <span class="o">=</span> <span class="nx">url</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span>
    <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">MONGOHQ_URL</span> <span class="o">||</span> <span class="s2">"mongodb://:@localhost:27017/my_db_name"</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">port</span><span class="o">:</span> <span class="nx">port</span><span class="p">,</span>
    <span class="nx">db</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">"host"</span><span class="o">:</span> <span class="nx">db_url</span><span class="p">.</span><span class="nx">hostname</span><span class="p">,</span>
        <span class="s2">"port"</span><span class="o">:</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">db_url</span><span class="p">.</span><span class="nx">port</span><span class="p">),</span>
        <span class="s2">"name"</span><span class="o">:</span> <span class="nx">db_url</span><span class="p">.</span><span class="nx">pathname</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
        <span class="s2">"credentials"</span><span class="o">:</span> <span class="p">{</span>
            <span class="s2">"username"</span><span class="o">:</span> <span class="nx">db_url</span><span class="p">.</span><span class="nx">auth</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">':'</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s2">"password"</span><span class="o">:</span> <span class="nx">db_url</span><span class="p">.</span><span class="nx">auth</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">':'</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="kd">var</span> <span class="nx">server</span> <span class="o">=</span> <span class="nx">deployd</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span>
<span class="nx">server</span><span class="p">.</span><span class="nx">listen</span><span class="p">();</span>

<span class="nx">server</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'listening'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Server is listening on "</span> <span class="o">+</span> <span class="nx">port</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">server</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'error'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
  <span class="nx">process</span><span class="p">.</span><span class="nx">nextTick</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="c1">// Give the server a chance to return an error</span>
    <span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">();</span>
  <span class="p">});</span>
<span class="p">});</span>
</pre></div></div>
        </div>
            
        
    <p>
        <a href="posts/mongodb-setup-deployd-heroku.html#disqus_thread" data-disqus-identifier="_cache/_posts/deployd-heroku-mongo-setup.html">Comments</a>


        </p></article>
        <article class="postbox h-entry">
        <h1 class="p-name"><a href="posts/strace-build-tools.html" class="u-url">strace &amp; build-tools</a>
        <small>  
             Posted: <time class="published dt-published" datetime="2013-01-11T05:00:00+00:00">2013-01-11</time>
        </small></h1>
        <hr>
        <div class="e-content">
        <div><p><a href="https://en.wikipedia.org/wiki/Strace">strace</a> is a utility to monitor
system calls. I.e. it can report all files open by a process.</p>
<p><a href="https://code.google.com/p/fabricate/">fabricate.py</a>
is a build-tool based on strace.
The idea is pretty cool. It will execute all commands through strace.
Than it can automatically figure out the dependencie and targets
by looking at the strace output.
So you don't need to explicitly specifying the dependencies and targets.</p>
<p>But these approach has a few problems:</p>
<ul>
<li>strace will slow down the execution</li>
</ul>
<p>(not only because of strace itself but also becaue it will have
    to parse strace output)</p>
<ul>
<li>not always correct. i.e. <code>run('cp', '-r', 'src', 'out')</code></li>
</ul>
<p>If you just add a file to the <code>src</code> it can not figure out that a "dependency"
   was added.</p>
<ul>
<li>confuse targets &amp; dependencies</li>
</ul>
<p>It checks the mode files were open, if open in write mode it is <em>target</em>.
   The problem is that some programs have their own cache system,
   so a target might be taken as a dependency.</p>
<p>Where these limitations are a problem or not depends on your use-case...</p>
<h4>doit &amp; strace</h4>
<p><a href="http://pydoit.org/">doit</a> takes a very different approach
to dependency handling.
All dependencies must be explicitly defined.</p>
<p><code>doit</code> doesn't support any kind of implicit dependency
but it now comes with a <code>strace</code> command that lets you easily check
which files are being used.</p>
<p>The idea is that you can use this feature while developing your tasks
and make sure you are setting the dependencies correctly.</p>
<p>Example:</p>
<div class="code"><pre><span class="k">def</span> <span class="nf">task_o</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">{</span><span class="s">'actions'</span><span class="p">:</span> <span class="p">[</span><span class="s">'cp abc abc2'</span><span class="p">,</span> <span class="s">'touch xyz'</span><span class="p">]}</span>
</pre></div>


<div class="code"><pre><span class="err">$</span> <span class="n">doit</span> <span class="n">strace</span> <span class="o">-</span><span class="n">f</span> <span class="n">traceme</span><span class="o">.</span><span class="n">py</span> <span class="n">o</span>
<span class="o">.</span>  <span class="n">o</span>
<span class="o">.</span>  <span class="n">strace_report</span>
<span class="n">R</span> <span class="o">/</span><span class="n">xxx</span><span class="o">/</span><span class="n">abc2</span>
<span class="n">R</span> <span class="o">/</span><span class="n">xxx</span><span class="o">/</span><span class="n">abc</span>
<span class="n">W</span> <span class="o">/</span><span class="n">xxx</span><span class="o">/</span><span class="n">abc2</span>
<span class="n">W</span> <span class="o">/</span><span class="n">xxx</span><span class="o">/</span><span class="n">xyz</span>
</pre></div>


<p>For more details check the <a href="http://pydoit.org/cmd_other.html#strace">docs</a>.</p></div>
        </div>
            
        
    <p>
        <a href="posts/strace-build-tools.html#disqus_thread" data-disqus-identifier="_cache/_posts/strace-build-tools.html">Comments</a>


        </p></article>
        <article class="postbox h-entry">
        <h1 class="p-name"><a href="posts/python-code-coverage-multiprocessing.html" class="u-url">python code coverage &amp; multiprocessing</a>
        <small>  
             Posted: <time class="published dt-published" datetime="2012-12-30T06:45:00+00:00">2012-12-30</time>
        </small></h1>
        <hr>
        <div class="e-content">
        <div><p>I wanted to get code <a href="http://nedbatchelder.com/code/coverage">coverage</a>
for my python code that uses the <a href="http://docs.python.org/2.7/library/multiprocessing.html">multiprocessing</a> module.</p>
<p>The default way of coverage <a href="http://nedbatchelder.com/code/coverage/subprocess.html">measuring in subprocess</a>
is to set the python interpreter to turn on code coverage right on start-up.
But this technique won't work if the process being measured <em>forks</em>
(as it does in multiprocessing).
See <a href="https://bitbucket.org/ned/coveragepy/issue/117/enable-coverage-measurement-of-code-run-by">issue</a>.</p>
<p>I solved this by monkey-patching the multiprocess to programmatically
start the coverage.
Only the method <code>Process._bootstrap</code> needs to be monkey-patched.
It is just wrapped with some code to start the coverage and
save it when it is done.</p>
<div class="code"><pre><span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Process</span>

<span class="k">def</span> <span class="nf">coverage_multiprocessing_process</span><span class="p">():</span> <span class="c"># pragma: no cover</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">coverage</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="c"># give up monkey-patching if coverage not installed</span>
        <span class="k">return</span>

    <span class="kn">from</span> <span class="nn">coverage.collector</span> <span class="kn">import</span> <span class="n">Collector</span>
    <span class="kn">from</span> <span class="nn">coverage.control</span> <span class="kn">import</span> <span class="n">coverage</span>
    <span class="c"># detect if coverage was running in forked process</span>
    <span class="k">if</span> <span class="n">Collector</span><span class="o">.</span><span class="n">_collectors</span><span class="p">:</span>
        <span class="k">class</span> <span class="nc">Process_WithCoverage</span><span class="p">(</span><span class="n">Process</span><span class="p">):</span>
            <span class="k">def</span> <span class="nf">_bootstrap</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="n">cov</span> <span class="o">=</span> <span class="n">coverage</span><span class="p">(</span><span class="n">data_suffix</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="n">cov</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">Process</span><span class="o">.</span><span class="n">_bootstrap</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                <span class="k">finally</span><span class="p">:</span>
                    <span class="n">cov</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
                    <span class="n">cov</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">Process_WithCoverage</span>

<span class="n">ProcessCoverage</span> <span class="o">=</span> <span class="n">coverage_multiprocessing_process</span><span class="p">()</span>
<span class="k">if</span> <span class="n">ProcessCoverage</span><span class="p">:</span>
    <span class="n">Process</span> <span class="o">=</span> <span class="n">ProcessCoverage</span>
</pre></div>


<p>Note that the monkey-patch is only applied when the original process
was being covered.
This is done by checking if there are any <code>Collector</code>.</p>
<p>When running the <code>coverage</code> you need use the <code>parallel-mode</code> and
than combine the results before creating report:</p>
<div class="code"><pre><span class="err">$</span> <span class="n">coverage</span> <span class="n">run</span> <span class="o">--</span><span class="n">parallel</span><span class="o">-</span><span class="n">mode</span> <span class="n">my_program</span><span class="p">.</span><span class="n">py</span>
<span class="err">$</span> <span class="n">coverage</span> <span class="n">combine</span>
<span class="err">$</span> <span class="n">coverage</span> <span class="n">report</span>
</pre></div></div>
        </div>
            
        
    <p>
        <a href="posts/python-code-coverage-multiprocessing.html#disqus_thread" data-disqus-identifier="_cache/_posts/coverage-multiprocessing.html">Comments</a>


        </p></article>
    
<div>
<ul class="pager">
    <li class="previous">
        <a href="index.html" rel="prev">← Newer posts</a>
    </li>
    <li class="next">
        <a href="index-1.html" rel="next">Older posts →</a>
    </li>
</ul>
</div>

    
        
       <script>var disqus_shortname="schettino72blog";(function(){var a=document.createElement("script");a.async=true;a.src="//"+disqus_shortname+".disqus.com/count.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)}());</script>


	


        <!--End of body content-->
    </div>
</div>

<div class="container">
        <footer>
            Contents © schettino72 - Powered by <a href="http://nikola.ralsina.com.ar">Nikola</a>
        </footer>
</div>


            <script src="assets/js/jquery-1.10.2.min.js" type="text/javascript"></script>
            <script src="assets/js/bootstrap.min.js" type="text/javascript"></script>
        <script src="assets/js/jquery.colorbox-min.js" type="text/javascript"></script>


    

    <script type="text/javascript">jQuery("a.image-reference").colorbox({rel:"gal",maxWidth:"100%",maxHeight:"100%",scalePhotos:true});</script>
    

<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-36931321-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>

</body>
</html>