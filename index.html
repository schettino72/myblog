<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="title" content="Rounder Wheels | Rounder Wheels"><meta name="description" content="on programming"><meta name="author" content="schettino72"><title>Rounder Wheels | Rounder Wheels</title><!-- Le styles --><link href="assets/css/bootstrap.css" rel="stylesheet" type="text/css"><link href="assets/css/rst.css" rel="stylesheet" type="text/css"><link href="assets/css/code.css" rel="stylesheet" type="text/css"><link href="assets/css/colorbox.css" rel="stylesheet" type="text/css"><link href="assets/css/slides.css" rel="stylesheet" type="text/css"><link href="assets/css/theme.css" rel="stylesheet" type="text/css"><link href="assets/css/custom.css" rel="stylesheet" type="text/css"><link href="assets/css/bootstrap-responsive.css" rel="stylesheet" type="text/css"><script src="assets/js/jquery-1.7.2.min.js" type="text/javascript"></script><script src="assets/js/jquery.colorbox-min.js" type="text/javascript"></script><script src="assets/js/slides.min.jquery.js" type="text/javascript"></script><script src="assets/js/bootstrap.min.js" type="text/javascript"></script><!-- Le HTML5 shim, for IE6-8 support of HTML5 elements --><!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js" type="text/javascript"></script>
    <![endif]--><link rel="alternate" type="application/rss+xml" title="RSS (en)" href="http://feeds.feedburner.com/schettino72"></head><body>
  <div class="container-fluid" id="container">
    <div class="row-fluid">
      <!-- top header -->
      <div class="span12" id="titlecolumn">
        <h1 id="blog-title">
          <a href="." title="Rounder Wheels">Rounder Wheels</a>
          <small>  by <a href="#">schettino72</a></small>
        </h1>
        
        <hr></div>

      <!-- content -->
      <div class="row-fluid" id="contentrow">
        <div class="span10" id="contentcolumn">
          <!--Body content-->
          
        <div class="postbox">
        <h1><a href="posts/strace-build-tools.html">strace &amp; build-tools</a>
        <small>  
             2013-01-11
        </small></h1>
        
            <a class="tag" href="categories/python.html"><span class="badge badge-info">python</span></a>
            <a class="tag" href="categories/doit.html"><span class="badge badge-info">doit</span></a>

        <hr><div><p><a href="https://en.wikipedia.org/wiki/Strace">strace</a> is a utility to monitor
system calls. I.e. it can report all files open by a process.</p>
<p><a href="https://code.google.com/p/fabricate/">fabricate.py</a>
is a build-tool based on strace.
The idea is pretty cool. It will execute all commands through strace.
Than it can automatically figure out the dependencie and targets
by looking at the strace output.
So you don't need to explicitly specifying the dependencies and targets.</p>
<p>But these approach has a few problems:</p>
<ul><li>strace will slow down the execution</li>
</ul><p>(not only because of strace itself but also becaue it will have
    to parse strace output)</p>
<ul><li>not always correct. i.e. <code>run('cp', '-r', 'src', 'out')</code></li>
</ul><p>If you just add a file to the <code>src</code> it can not figure out that a "dependency"
   was added.</p>
<ul><li>confuse targets &amp; dependencies</li>
</ul><p>It checks the mode files were open, if open in write mode it is <em>target</em>.
   The problem is that some programs have their own cache system,
   so a target might be taken as a dependency.</p>
<p>Where these limitations are a problem or not depends on your use-case...</p>
<h3>doit &amp; strace</h3>
<p><a href="http://pydoit.org/">doit</a> takes a very different approach
to dependency handling.
All dependencies must be explicitly defined.</p>
<p><code>doit</code> doesn't support any kind of implicit dependency
but it now comes with a <code>strace</code> command that lets you easily check
which files are being used.</p>
<p>The idea is that you can use this feature while developing your tasks
and make sure you are setting the dependencies correctly.</p>
<p>Example:</p>
<div class="code"><pre><span class="k">def</span> <span class="nf">task_o</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">{</span><span class="s">'actions'</span><span class="p">:</span> <span class="p">[</span><span class="s">'cp abc abc2'</span><span class="p">,</span> <span class="s">'touch xyz'</span><span class="p">]}</span>
</pre></div>


<div class="code"><pre><span class="err">$</span> <span class="n">doit</span> <span class="n">strace</span> <span class="o">-</span><span class="n">f</span> <span class="n">traceme</span><span class="o">.</span><span class="n">py</span> <span class="n">o</span>
<span class="o">.</span>  <span class="n">o</span>
<span class="o">.</span>  <span class="n">strace_report</span>
<span class="n">R</span> <span class="o">/</span><span class="n">xxx</span><span class="o">/</span><span class="n">abc2</span>
<span class="n">R</span> <span class="o">/</span><span class="n">xxx</span><span class="o">/</span><span class="n">abc</span>
<span class="n">W</span> <span class="o">/</span><span class="n">xxx</span><span class="o">/</span><span class="n">abc2</span>
<span class="n">W</span> <span class="o">/</span><span class="n">xxx</span><span class="o">/</span><span class="n">xyz</span>
</pre></div>


<p>For more details check the <a href="http://pydoit.org/cmd_other.html#strace">docs</a>.</p></div>
        
    <p>
        <a href="posts/strace-build-tools.html#disqus_thread" data-disqus-identifier="_cache/_posts/strace-build-tools.html">Comments</a>

        </p></div>
        <div class="postbox">
        <h1><a href="posts/python-code-coverage-multiprocessing.html">python code coverage &amp; multiprocessing</a>
        <small>  
             2012-12-30
        </small></h1>
        
            <a class="tag" href="categories/python.html"><span class="badge badge-info">python</span></a>

        <hr><div><p>I wanted to get code <a href="http://nedbatchelder.com/code/coverage">coverage</a>
for my python code that uses the <a href="http://docs.python.org/2.7/library/multiprocessing.html">multiprocessing</a> module.</p>
<p>The default way of coverage <a href="http://nedbatchelder.com/code/coverage/subprocess.html">measuring in subprocess</a>
is to set the python interpreter to turn on code coverage right on start-up.
But this technique won't work if the process being measured <em>forks</em>
(as it does in multiprocessing).
See <a href="https://bitbucket.org/ned/coveragepy/issue/117/enable-coverage-measurement-of-code-run-by">issue</a>.</p>
<p>I solved this by monkey-patching the multiprocess to programmatically
start the coverage.
Only the method <code>Process._bootstrap</code> needs to be monkey-patched.
It is just wrapped with some code to start the coverage and
save it when it is done.</p>
<div class="code"><pre><span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Process</span>

<span class="k">def</span> <span class="nf">coverage_multiprocessing_process</span><span class="p">():</span> <span class="c"># pragma: no cover</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">coverage</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="c"># give up monkey-patching if coverage not installed</span>
        <span class="k">return</span>

    <span class="kn">from</span> <span class="nn">coverage.collector</span> <span class="kn">import</span> <span class="n">Collector</span>
    <span class="kn">from</span> <span class="nn">coverage.control</span> <span class="kn">import</span> <span class="n">coverage</span>
    <span class="c"># detect if coverage was running in forked process</span>
    <span class="k">if</span> <span class="n">Collector</span><span class="o">.</span><span class="n">_collectors</span><span class="p">:</span>
        <span class="k">class</span> <span class="nc">Process_WithCoverage</span><span class="p">(</span><span class="n">Process</span><span class="p">):</span>
            <span class="k">def</span> <span class="nf">_bootstrap</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="n">cov</span> <span class="o">=</span> <span class="n">coverage</span><span class="p">(</span><span class="n">data_suffix</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="n">cov</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">Process</span><span class="o">.</span><span class="n">_bootstrap</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                <span class="k">finally</span><span class="p">:</span>
                    <span class="n">cov</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
                    <span class="n">cov</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">Process_WithCoverage</span>

<span class="n">ProcessCoverage</span> <span class="o">=</span> <span class="n">coverage_multiprocessing_process</span><span class="p">()</span>
<span class="k">if</span> <span class="n">ProcessCoverage</span><span class="p">:</span>
    <span class="n">Process</span> <span class="o">=</span> <span class="n">ProcessCoverage</span>
</pre></div>


<p>Note that the monkey-patch is only applied when the original process
was being covered.
This is done by checking if there are any <code>Collector</code>.</p>
<p>When running the <code>coverage</code> you need use the <code>parallel-mode</code> and
than combine the results before creating report:</p>
<div class="code"><pre>$ <span class="n">coverage</span> <span class="n">run</span> <span class="o">--</span><span class="n">parallel</span><span class="o">-</span><span class="n">mode</span> <span class="n">my_program</span><span class="p">.</span><span class="n">py</span>
$ <span class="n">coverage</span> <span class="n">combine</span>
$ <span class="n">coverage</span> <span class="n">report</span>
</pre></div></div>
        
    <p>
        <a href="posts/python-code-coverage-multiprocessing.html#disqus_thread" data-disqus-identifier="_cache/_posts/coverage-multiprocessing.html">Comments</a>

        </p></div>
        <div class="postbox">
        <h1><a href="posts/doit-task-creation.html">doit task creation</a>
        <small>  
             2012-12-15
        </small></h1>
        
            <a class="tag" href="categories/python.html"><span class="badge badge-info">python</span></a>
            <a class="tag" href="categories/doit.html"><span class="badge badge-info">doit</span></a>

        <hr><div><p>On my previous <a href="http://blog.schettino72.net/posts/doit-task-decorator.html">post</a>
I explained one way to create tasks for <a href="http://pydoit.org">doit</a>
in a higher level than the default plain python dictionaries.</p>
<p>I just pushed a <a href="https://bitbucket.org/schettino72/doit/commits/136e7fc9b1f779a22546a787ddb01048db74b264">change</a>
that will allow the creation of not only decorators to generate tasks but also
classes and instance objects.</p>
<p>The idea is very simple. Apart from collect functions that start with the
name <code>task_</code>. The <em>doit</em> loader will now also execute the <code>create_doit_task</code>
callable from any object that contains this attribute.</p>
<p>Note you will need the developement version of <code>doit</code> to run this code.</p>
<h3>decorator example</h3>
<div class="code"><pre><span class="c">##########################################################</span>
<span class="c">## the decorator</span>

<span class="k">def</span> <span class="nf">task</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">meta</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">decorated</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">create</span><span class="p">():</span>
            <span class="n">task_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s">'basename'</span><span class="p">:</span> <span class="n">func</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="s">'actions'</span><span class="p">:</span> <span class="p">[</span><span class="n">func</span><span class="p">]}</span>
            <span class="n">task_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">meta</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">task_dict</span>
        <span class="n">func</span><span class="o">.</span><span class="n">create_doit_tasks</span> <span class="o">=</span> <span class="n">create</span>
        <span class="k">return</span> <span class="n">func</span>

    <span class="k">if</span> <span class="n">args</span><span class="p">:</span>
        <span class="c"># decorator without parameters</span>
        <span class="k">return</span> <span class="n">decorated</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">decorated</span>

<span class="c">###########################################################</span>
<span class="c">## task definition</span>

<span class="n">DOIT_CONFIG</span> <span class="o">=</span> <span class="p">{</span><span class="s">'verbosity'</span><span class="p">:</span> <span class="mi">2</span><span class="p">}</span>

<span class="nd">@task</span>
<span class="k">def</span> <span class="nf">simple</span><span class="p">():</span>
    <span class="k">print</span> <span class="s">"ho"</span>

<span class="nd">@task</span><span class="p">(</span><span class="n">file_dep</span><span class="o">=</span><span class="p">[</span><span class="s">'dodo.py'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">hello</span><span class="p">():</span>
    <span class="k">print</span> <span class="s">"hi"</span>
</pre></div>


<h3>class example</h3>
<p>This interface was suggested by Thomas <a href="https://groups.google.com/d/topic/python-doit/hp6wFvjcw1k/discussion">here</a>.</p>
<div class="code"><pre><span class="k">class</span> <span class="nc">Task</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">create_doit_tasks</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">cls</span> <span class="ow">is</span> <span class="n">Task</span><span class="p">:</span>
            <span class="k">return</span> <span class="c"># avoid create tasks from base class 'Task'</span>
        <span class="n">instance</span> <span class="o">=</span> <span class="n">cls</span><span class="p">()</span>
        <span class="n">kw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">a</span><span class="p">))</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">a</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">'_'</span><span class="p">))</span>
        <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">'create_doit_tasks'</span><span class="p">)</span>
        <span class="k">if</span> <span class="s">'actions'</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kw</span><span class="p">:</span>
            <span class="n">kw</span><span class="p">[</span><span class="s">'actions'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">'run'</span><span class="p">)]</span>
        <span class="k">if</span> <span class="s">'doc'</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kw</span><span class="p">:</span>
            <span class="n">kw</span><span class="p">[</span><span class="s">'doc'</span><span class="p">]</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">__doc__</span>
        <span class="k">return</span> <span class="n">kw</span>

<span class="k">class</span> <span class="nc">hello</span><span class="p">(</span><span class="n">Task</span><span class="p">):</span>
    <span class="sd">"""Hello from Python."""</span>
    <span class="n">targets</span> <span class="o">=</span> <span class="p">[</span><span class="s">'hello.txt'</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">targets</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">"a"</span><span class="p">)</span> <span class="k">as</span> <span class="n">output</span><span class="p">:</span>
            <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">"Hello world."</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">checker</span><span class="p">(</span><span class="n">Task</span><span class="p">):</span>
    <span class="sd">"""Run pyflakes."""</span>
    <span class="n">actions</span> <span class="o">=</span> <span class="p">[</span><span class="s">'pyflakes sample.py'</span><span class="p">]</span>
    <span class="n">file_dep</span> <span class="o">=</span> <span class="p">[</span><span class="s">'sample.py'</span><span class="p">]</span>
</pre></div>


<h3>Object example</h3>
<div class="code"><pre><span class="k">class</span> <span class="nc">TaskHello</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">REG</span> <span class="o">=</span> <span class="p">[]</span> <span class="c"># save instances</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">REG</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">say_hello</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">print</span> <span class="s">"hello"</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">create_doit_tasks</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">inst</span> <span class="ow">in</span> <span class="n">cls</span><span class="o">.</span><span class="n">REG</span><span class="p">:</span>
            <span class="k">yield</span> <span class="p">{</span>
                <span class="s">'basename'</span><span class="p">:</span> <span class="n">inst</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="s">'actions'</span><span class="p">:</span> <span class="p">[</span><span class="n">inst</span><span class="o">.</span><span class="n">say_hello</span><span class="p">],</span>
                <span class="p">}</span>

<span class="c">######################</span>

<span class="n">DOIT_CONFIG</span> <span class="o">=</span> <span class="p">{</span><span class="s">'verbosity'</span><span class="p">:</span> <span class="mi">2</span><span class="p">}</span>

<span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">(</span><span class="s">'foo'</span><span class="p">,</span> <span class="s">'bar'</span><span class="p">,</span> <span class="s">'spam'</span><span class="p">):</span>
    <span class="n">TaskHello</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</pre></div></div>
        
    <p>
        <a href="posts/doit-task-creation.html#disqus_thread" data-disqus-identifier="_cache/_posts/doit-task-creation.html">Comments</a>

        </p></div>
    
<div>
<ul class="pager"><li class="next">
        <a href="index-1.html">Older posts →</a>
    </li>
</ul></div>

    
       <script type="text/javascript">var disqus_shortname="schettino72blog";(function(){var a=document.createElement("script");a.async=true;a.type="text/javascript";a.src="http://"+disqus_shortname+".disqus.com/count.js";(document.getElementsByTagName("HEAD")[0]||document.getElementsByTagName("BODY")[0]).appendChild(a)}());</script><!--End of body content--><hr><small>Contents © 2012 schettino72 - Powered by <a href="http://nikola.ralsina.com.ar">Nikola</a></small>
      </div>

      <!--Sidebar content-->
      <div class="span2" id="sidebar">
        <ul class="unstyled"><li>
  <a href="http://feeds.feedburner.com/schettino72?format=xml" rel="alternate" type="application/rss+xml"><img src="http://www.feedburner.com/fb/images/pub/feed-icon16x16.png" alt="" style="vertical-align:middle;border:0"></a> <a href="http://feeds.feedburner.com/schettino72?format=xml" rel="alternate" type="application/rss+xml">feed</a>
</li>
          <li>
            </li><li><a href="archive/index.html">Archives</a>
            </li><li><a href="categories/index.html">Tags</a>
</li>
          <li>
        </ul></div>
      <!--End of sidebar content-->

      
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-36931321-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script></div></div></div></body></html>